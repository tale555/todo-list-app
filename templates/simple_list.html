{% extends "base.html" %} {% block title %}Todoä¸€è¦§ - Todo List App{% endblock
%} {% block content %}
<div class="simple-list-container">
  <div class="todo-header">
    <h2>Todoä¸€è¦§</h2>
    <div class="todo-header-actions">
      <a href="{{ url_for('index') }}" class="btn btn-secondary">è©³ç´°è¡¨ç¤º</a>
      <a href="{{ url_for('drafts') }}" class="btn btn-draft">ä¸€æ™‚ä¿å­˜</a>
      <a href="{{ url_for('create_todo') }}" class="btn btn-primary"
        >æ–°è¦ä½œæˆ</a
      >
    </div>
  </div>

  {% if todos %}
  <div class="simple-todo-list" id="simple-todo-list">
    {% for todo in todos %}
    <div
      class="simple-todo-item {% if todo.is_completed %}completed{% endif %} {% if todo.is_overdue %}overdue{% elif todo.is_due_today %}due-today{% elif todo.is_due_tomorrow %}due-tomorrow{% elif todo.is_due_soon %}due-soon{% endif %}"
      draggable="true"
      data-todo-id="{{ todo.id }}"
      {%
      if
      todo.is_completed
      %}style="display: none;"
      {%
      endif
      %}
    >
      <div class="simple-todo-content">
        <div class="simple-todo-title-row">
          <div
            class="simple-todo-title {% if todo.is_completed %}completed-text{% endif %}"
          >
            {{ todo.title }}
          </div>
          {% if todo.category %}
          <span
            class="category-badge category-{{ todo.category|lower|replace(' ', '-')|replace('ã€€', '-') }}"
            >{{ todo.category }}</span
          >
          {% endif %}
        </div>
        <div class="simple-todo-date">
          <span class="date-value">{{ todo.formatted_due_date }}</span>
          {% if todo.is_overdue %}
          <span class="badge badge-danger">æœŸé™åˆ‡ã‚Œ</span>
          {% elif todo.is_due_today %}
          <span class="badge badge-today"><strong>æœ¬æ—¥æœŸé™</strong></span>
          {% elif todo.is_due_tomorrow %}
          <span class="badge badge-tomorrow"><strong>æ˜æ—¥ã¾ã§</strong></span>
          {% elif todo.is_due_soon %}
          <span class="badge badge-warning">æœŸé™é–“è¿‘</span>
          {% endif %}
        </div>
      </div>
      <div class="simple-todo-actions">
        <a
          href="{{ url_for('edit_todo', todo_id=todo.id) }}"
          class="btn btn-edit btn-sm"
          onclick="event.stopPropagation();"
          >ç·¨é›†</a
        >
        <form
          method="POST"
          action="{{ url_for('delete_todo', todo_id=todo.id) }}"
          onsubmit="return confirm('ã“ã®Todoã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');"
          style="display: inline-block"
          class="delete-form"
          onclick="event.stopPropagation();"
        >
          <button
            type="submit"
            class="btn btn-delete btn-sm"
            name="delete"
            value="{{ todo.id }}"
            style="min-width: auto"
          >
            å‰Šé™¤
          </button>
        </form>
        <button
          type="button"
          class="btn btn-sm {% if todo.is_completed %}btn-completed{% else %}btn-complete{% endif %}"
          onclick="event.stopPropagation(); toggleCompletion('{{ todo.id }}', this)"
        >
          {% if todo.is_completed %}æœªå®Œäº†{% else %}å®Œäº†{% endif %}
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <p class="empty-message">ğŸ“ TodoãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    <a href="{{ url_for('create_todo') }}" class="btn btn-primary"
      >æœ€åˆã®Todoã‚’ä½œæˆ</a
    >
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  function toggleCompletion(todoId, button) {
    const todoItem = button.closest(".simple-todo-item");

    fetch(`/toggle-completion/${todoId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          if (data.is_completed) {
            todoItem.classList.add("completed");
            todoItem.querySelectorAll(".simple-todo-title").forEach((el) => {
              el.classList.add("completed-text");
            });
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            button.textContent = "æœªå®Œäº†";
            button.classList.remove("btn-complete");
            button.classList.add("btn-completed");

            // å®Œäº†æ¸ˆã¿ã¯å³åº§ã«éè¡¨ç¤ºã«ã™ã‚‹
            todoItem.style.display = "none";
          } else {
            todoItem.classList.remove("completed");
            todoItem.querySelectorAll(".simple-todo-title").forEach((el) => {
              el.classList.remove("completed-text");
            });
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            button.textContent = "å®Œäº†";
            button.classList.remove("btn-completed");
            button.classList.add("btn-complete");

            // æœªå®Œäº†ã«æˆ»ã—ãŸå ´åˆã¯å³åº§ã«è¡¨ç¤ºã™ã‚‹
            todoItem.style.display = "";
          }
        } else {
          alert(
            "å®Œäº†çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼")
          );
        }
      })
      .catch((error) => {
        console.error("ã‚¨ãƒ©ãƒ¼:", error);
        alert("å®Œäº†çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const todoList = document.getElementById("simple-todo-list");
    if (!todoList) return;

    let draggedElement = null;
    let isDragging = false;
    let touchStartY = 0;
    let touchCurrentY = 0;

    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆãƒã‚¦ã‚¹ï¼‰
    todoList.addEventListener("dragstart", function (e) {
      // ãƒœã‚¿ãƒ³ã‚„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹åŒ–
      if (
        e.target.closest(".simple-todo-actions") ||
        e.target.closest(".btn") ||
        e.target.closest("form")
      ) {
        e.preventDefault();
        return;
      }

      if (e.target.classList.contains("simple-todo-item")) {
        draggedElement = e.target;
        isDragging = true;
        e.target.style.opacity = "0.5";
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", e.target.outerHTML);
      }
    });

    // ã‚¿ãƒƒãƒé–‹å§‹ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
    todoList.addEventListener(
      "touchstart",
      function (e) {
        // ãƒœã‚¿ãƒ³ã‚„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¿ãƒƒãƒã—ãŸå ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹åŒ–
        if (
          e.target.closest(".simple-todo-actions") ||
          e.target.closest(".btn") ||
          e.target.closest("form")
        ) {
          return;
        }

        const item = e.target.closest(".simple-todo-item");
        if (item) {
          draggedElement = item;
          touchStartY = e.touches[0].clientY;
          touchCurrentY = touchStartY;
          item.style.opacity = "0.5";
          item.style.transition = "none";
        }
      },
      { passive: true }
    );

    // ã‚¿ãƒƒãƒç§»å‹•ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
    todoList.addEventListener(
      "touchmove",
      function (e) {
        if (!draggedElement) return;

        e.preventDefault();
        touchCurrentY = e.touches[0].clientY;
        const deltaY = touchCurrentY - touchStartY;

        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‚’è¦–è¦šçš„ã«ç§»å‹•
        draggedElement.style.transform = `translateY(${deltaY}px)`;

        // ä»–ã®è¦ç´ ã¨ã®ä½ç½®é–¢ä¿‚ã‚’æ›´æ–°
        const afterElement = getDragAfterElement(todoList, touchCurrentY);
        const allItems = todoList.querySelectorAll(".simple-todo-item");
        allItems.forEach((item) => {
          if (item !== draggedElement) {
            item.classList.remove("drag-over");
          }
        });

        // DOMã®é †åºã‚’å®Ÿéš›ã«å¤‰æ›´
        if (afterElement && afterElement !== draggedElement) {
          afterElement.classList.add("drag-over");
          if (afterElement.nextSibling === draggedElement) {
            // æ—¢ã«æ­£ã—ã„ä½ç½®ã«ã‚ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
          } else {
            todoList.insertBefore(draggedElement, afterElement);
          }
        } else if (
          afterElement === null &&
          draggedElement !== todoList.lastElementChild
        ) {
          // æœ€å¾Œã«ç§»å‹•
          todoList.appendChild(draggedElement);
        }
      },
      { passive: false }
    );

    // ã‚¿ãƒƒãƒçµ‚äº†ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
    todoList.addEventListener(
      "touchend",
      function (e) {
        if (!draggedElement) return;

        const item = draggedElement;
        item.style.opacity = "1";
        item.style.transform = "";
        item.style.transition = "";

        // é †åºã‚’æ›´æ–°
        const todos = Array.from(todoList.children);
        const orders = todos.map((item, index) => ({
          id: item.getAttribute("data-todo-id"),
          order: index + 1,
        }));

        // ã‚µãƒ¼ãƒãƒ¼ã«é †åºã‚’é€ä¿¡
        fetch("/update-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ orders: orders }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("é †åºã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            } else {
              console.error("é †åºã®æ›´æ–°ã«å¤±æ•—:", data.error);
              location.reload();
            }
          })
          .catch((error) => {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
            location.reload();
          });

        // ã™ã¹ã¦ã®è¦ç´ ã‹ã‚‰drag-overã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        const allItems = todoList.querySelectorAll(".simple-todo-item");
        allItems.forEach((item) => item.classList.remove("drag-over"));

        draggedElement = null;
        touchStartY = 0;
        touchCurrentY = 0;
      },
      { passive: true }
    );

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
    todoList.addEventListener("dragover", function (e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";

      if (!draggedElement) return;

      const afterElement = getDragAfterElement(todoList, e.clientY);

      // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
      const allItems = todoList.querySelectorAll(".simple-todo-item");
      allItems.forEach((item) => item.classList.remove("drag-over"));

      if (afterElement == null) {
        todoList.appendChild(draggedElement);
      } else {
        todoList.insertBefore(draggedElement, afterElement);
        if (afterElement !== draggedElement) {
          afterElement.classList.add("drag-over");
        }
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
    todoList.addEventListener("dragleave", function (e) {
      const allItems = todoList.querySelectorAll(".simple-todo-item");
      allItems.forEach((item) => item.classList.remove("drag-over"));
    });

    // ãƒ‰ãƒ­ãƒƒãƒ—
    todoList.addEventListener("drop", function (e) {
      e.preventDefault();
      if (draggedElement && draggedElement.parentNode) {
        draggedElement.style.opacity = "1";
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    todoList.addEventListener("dragend", function (e) {
      if (e.target.classList.contains("simple-todo-item")) {
        e.target.style.opacity = "1";
        isDragging = false;

        // é †åºã‚’æ›´æ–°
        const todos = Array.from(todoList.children);
        const orders = todos.map((item, index) => ({
          id: item.getAttribute("data-todo-id"),
          order: index + 1,
        }));

        // ã‚µãƒ¼ãƒãƒ¼ã«é †åºã‚’é€ä¿¡
        fetch("/update-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ orders: orders }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("é †åºã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            } else {
              console.error("é †åºã®æ›´æ–°ã«å¤±æ•—:", data.error);
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
              location.reload();
            }
          })
          .catch((error) => {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
            location.reload();
          });
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®å¾Œã«é…ç½®ã™ã‚‹è¦ç´ ã‚’å–å¾—ï¼ˆãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒä¸¡å¯¾å¿œï¼‰
    function getDragAfterElement(container, y) {
      const draggableElements = [
        ...container.querySelectorAll(".simple-todo-item:not(.dragging)"),
      ];

      return draggableElements.reduce(
        (closest, child) => {
          if (child === draggedElement) return closest;
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;

          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY }
      ).element;
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ /å‰Šé™¤
    todoList.addEventListener("drag", function (e) {
      if (e.target.classList.contains("simple-todo-item")) {
        e.target.classList.add("dragging");
      }
    });

    todoList.addEventListener("dragend", function (e) {
      if (e.target.classList.contains("simple-todo-item")) {
        e.target.classList.remove("dragging");
        const allItems = todoList.querySelectorAll(".simple-todo-item");
        allItems.forEach((item) => item.classList.remove("drag-over"));
      }
    });

    // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤ºã«æˆ»ã‚‹ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ç„¡åŠ¹ï¼‰
    todoList.addEventListener("click", function (e) {
      if (isDragging) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }

      // ãƒœã‚¿ãƒ³ã‚„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯è©³ç´°è¡¨ç¤ºã«æˆ»ã‚‰ãªã„
      if (
        e.target.closest(".simple-todo-actions") ||
        e.target.closest(".btn") ||
        e.target.closest("form")
      ) {
        return;
      }

      const item = e.target.closest(".simple-todo-item");
      if (item && !item.classList.contains("dragging")) {
        window.location.href = "{{ url_for('index') }}";
      }
    });
  });
</script>
{% endblock %}
