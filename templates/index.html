{% extends "base.html" %} {% block title %}Todoä¸€è¦§ - Todo List App{% endblock
%} {% block content %}
<div class="todo-list-container">
  <div class="todo-header">
    <h2>Todoä¸€è¦§</h2>
    <div class="todo-header-actions">
      <a href="{{ url_for('simple_list') }}" class="btn btn-secondary">ä¸€è¦§</a>
      <a href="{{ url_for('drafts') }}" class="btn btn-draft">ä¸€æ™‚ä¿å­˜</a>
      <a href="{{ url_for('create_todo') }}" class="btn btn-primary"
        >æ–°è¦ä½œæˆ</a
      >
    </div>
  </div>

  <div class="search-filter-container">
    <div class="search-box">
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»å†…å®¹ã§æ¤œç´¢..."
      />
      <button
        type="button"
        id="clear-search"
        class="clear-search-btn"
        style="display: none"
      >
        âœ•
      </button>
    </div>
    <div class="filter-buttons">
      <button type="button" class="filter-btn" data-filter="all">ã™ã¹ã¦</button>
      <button type="button" class="filter-btn active" data-filter="active">
        æœªå®Œäº†
      </button>
      <button type="button" class="filter-btn" data-filter="completed">
        å®Œäº†æ¸ˆã¿
      </button>
      <button type="button" class="filter-btn" data-filter="overdue">
        æœŸé™åˆ‡ã‚Œ
      </button>
      <button type="button" class="filter-btn" data-filter="today">
        æœ¬æ—¥æœŸé™
      </button>
      <button type="button" class="filter-btn" data-filter="tomorrow">
        æ˜æ—¥ã¾ã§
      </button>
      <button type="button" class="filter-btn" data-filter="soon">
        æœŸé™é–“è¿‘
      </button>
    </div>
    {% if categories %}
    <div class="category-filters">
      <span class="filter-label">ã‚«ãƒ†ã‚´ãƒª:</span>
      <button type="button" class="category-filter-btn active" data-category="">
        ã™ã¹ã¦
      </button>
      {% for cat in categories %}
      <button
        type="button"
        class="category-filter-btn"
        data-category="{{ cat }}"
      >
        {{ cat }}
      </button>
      {% endfor %}
    </div>
    {% endif %}
    <div class="drag-hint">
      <small
        >ğŸ’¡ ãƒ’ãƒ³ãƒˆ:
        Todoã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã§ãã¾ã™</small
      >
    </div>
  </div>

  {% if todos %}
  <div class="todo-list" id="todo-list">
    {% for todo in todos %}
    <div
      class="todo-item {% if todo.is_completed %}completed{% endif %} {% if todo.is_overdue %}overdue{% elif todo.is_due_today %}due-today{% elif todo.is_due_tomorrow %}due-tomorrow{% elif todo.is_due_soon %}due-soon{% endif %}"
      draggable="true"
      data-todo-id="{{ todo.id }}"
      {%
      if
      todo.is_completed
      %}style="display: none;"
      {%
      endif
      %}
    >
      <div class="todo-content">
        <div class="todo-title-row">
          <h3
            class="todo-title {% if todo.is_completed %}completed-text{% endif %}"
          >
            {{ todo.title }}
          </h3>
          {% if todo.category %}
          <span
            class="category-badge category-{{ todo.category|lower|replace(' ', '-')|replace('ã€€', '-') }}"
            >{{ todo.category }}</span
          >
          {% endif %}
        </div>
        <p
          class="todo-description {% if todo.is_completed %}completed-text{% endif %}"
        >
          {{ todo.content }}
        </p>
        <div class="todo-meta">
          <span class="todo-date">
            <strong>æœŸæ—¥:</strong>
            <span class="date-value">{{ todo.formatted_due_date }}</span>
            {% if todo.is_overdue %}
            <span class="badge badge-danger">æœŸé™åˆ‡ã‚Œ</span>
            {% elif todo.is_due_today %}
            <span class="badge badge-today"><strong>æœ¬æ—¥æœŸé™</strong></span>
            {% elif todo.is_due_tomorrow %}
            <span class="badge badge-tomorrow"><strong>æ˜æ—¥ã¾ã§</strong></span>
            {% elif todo.is_due_soon %}
            <span class="badge badge-warning">æœŸé™é–“è¿‘</span>
            {% endif %}
          </span>
          <span class="todo-created">
            ä½œæˆæ—¥: {{ todo.formatted_created_at }}
          </span>
        </div>
      </div>
      <div class="todo-actions">
        <a
          href="{{ url_for('edit_todo', todo_id=todo.id) }}"
          class="btn btn-edit"
          >ç·¨é›†</a
        >
        <form
          method="POST"
          action="{{ url_for('delete_todo', todo_id=todo.id) }}"
          onsubmit="return confirm('ã“ã®Todoã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');"
          style="display: inline-block"
          class="delete-form"
        >
          <button
            type="submit"
            class="btn btn-delete"
            name="delete"
            value="{{ todo.id }}"
          >
            å‰Šé™¤
          </button>
        </form>
        <button
          type="button"
          class="btn {% if todo.is_completed %}btn-completed{% else %}btn-complete{% endif %}"
          onclick="toggleCompletion('{{ todo.id }}', this)"
        >
          {% if todo.is_completed %}æœªå®Œäº†{% else %}å®Œäº†{% endif %}
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <p class="empty-message">ğŸ“ TodoãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    <a href="{{ url_for('create_todo') }}" class="btn btn-primary"
      >æœ€åˆã®Todoã‚’ä½œæˆ</a
    >
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search-input");
    const clearSearchBtn = document.getElementById("clear-search");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const categoryFilterButtons = document.querySelectorAll(
      ".category-filter-btn"
    );
    const todoItems = document.querySelectorAll(".todo-item");

    // æ¤œç´¢å…¥åŠ›ã®å‡¦ç†
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        clearSearchBtn.style.display = this.value ? "block" : "none";
        filterTodos();
      });

      clearSearchBtn.addEventListener("click", function () {
        searchInput.value = "";
        clearSearchBtn.style.display = "none";
        filterTodos();
      });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
    filterButtons.forEach((btn) => {
      btn.addEventListener("click", function () {
        filterButtons.forEach((b) => b.classList.remove("active"));
        this.classList.add("active");
        filterTodos();
      });
    });

    // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç†
    categoryFilterButtons.forEach((btn) => {
      btn.addEventListener("click", function () {
        categoryFilterButtons.forEach((b) => b.classList.remove("active"));
        this.classList.add("active");
        filterTodos();
      });
    });

    function filterTodos() {
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";
      const activeFilter =
        document.querySelector(".filter-btn.active")?.dataset.filter || "all";
      const activeCategory =
        document.querySelector(".category-filter-btn.active")?.dataset
          .category || "";

      todoItems.forEach((item) => {
        const title =
          item.querySelector(".todo-title")?.textContent.toLowerCase() || "";
        const content =
          item.querySelector(".todo-description")?.textContent.toLowerCase() ||
          "";
        const category =
          item.querySelector(".category-badge")?.textContent || "";
        const isCompleted = item.classList.contains("completed");
        const isOverdue = item.classList.contains("overdue");
        const isDueToday = item.classList.contains("due-today");
        const isDueTomorrow = item.classList.contains("due-tomorrow");
        const isDueSoon = item.classList.contains("due-soon");

        // æ¤œç´¢æ¡ä»¶
        const matchesSearch =
          !searchTerm ||
          title.includes(searchTerm) ||
          content.includes(searchTerm);

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
        let matchesFilter = true;
        if (activeFilter === "all") {
          // ã€Œã™ã¹ã¦ã€ã®å ´åˆã‚‚å®Œäº†æ¸ˆã¿ã¯éè¡¨ç¤ºï¼ˆå®Œäº†æ¸ˆã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§è¡¨ç¤ºï¼‰
          if (isCompleted) matchesFilter = false;
        } else if (activeFilter === "active" && isCompleted) {
          matchesFilter = false;
        } else if (activeFilter === "completed" && !isCompleted) {
          matchesFilter = false;
        } else if (activeFilter === "overdue" && !isOverdue) {
          matchesFilter = false;
        } else if (activeFilter === "today" && !isDueToday) {
          matchesFilter = false;
        } else if (activeFilter === "tomorrow" && !isDueTomorrow) {
          matchesFilter = false;
        } else if (activeFilter === "soon" && !isDueSoon) {
          matchesFilter = false;
        }

        // ã‚«ãƒ†ã‚´ãƒªæ¡ä»¶
        const matchesCategory = !activeCategory || category === activeCategory;

        // è¡¨ç¤º/éè¡¨ç¤º
        if (matchesSearch && matchesFilter && matchesCategory) {
          item.style.display = "";
        } else {
          item.style.display = "none";
        }
      });

      // ç©ºã®çŠ¶æ…‹ã‚’è¡¨ç¤º/éè¡¨ç¤º
      const visibleItems = Array.from(todoItems).filter(
        (item) => item.style.display !== "none"
      );
      const emptyState = document.querySelector(".empty-state");
      if (emptyState) {
        emptyState.style.display = visibleItems.length === 0 ? "block" : "none";
      }
    }
  });

  function toggleCompletion(todoId, button) {
    fetch(`/toggle-completion/${todoId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const todoItem = button.closest(".todo-item");
          const activeFilter =
            document.querySelector(".filter-btn.active")?.dataset.filter ||
            "active";

          if (data.is_completed) {
            todoItem.classList.add("completed");
            todoItem
              .querySelectorAll(".todo-title, .todo-description")
              .forEach((el) => {
                el.classList.add("completed-text");
              });
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            button.textContent = "æœªå®Œäº†";
            button.classList.remove("btn-complete");
            button.classList.add("btn-completed");

            // å®Œäº†æ¸ˆã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯å³åº§ã«éè¡¨ç¤ºã«ã™ã‚‹
            if (activeFilter !== "completed") {
              todoItem.style.display = "none";
            }
          } else {
            todoItem.classList.remove("completed");
            todoItem
              .querySelectorAll(".todo-title, .todo-description")
              .forEach((el) => {
                el.classList.remove("completed-text");
              });
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            button.textContent = "å®Œäº†";
            button.classList.remove("btn-completed");
            button.classList.add("btn-complete");

            // æœªå®Œäº†ã«æˆ»ã—ãŸå ´åˆã¯è¡¨ç¤ºã™ã‚‹
            todoItem.style.display = "";
          }
        } else {
          alert(
            "å®Œäº†çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼")
          );
        }
      })
      .catch((error) => {
        console.error("ã‚¨ãƒ©ãƒ¼:", error);
        alert("å®Œäº†çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const todoList = document.getElementById("todo-list");
    if (!todoList) return;

    let draggedElement = null;
    let draggedIndex = null;

    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    todoList.addEventListener("dragstart", function (e) {
      // ãƒœã‚¿ãƒ³ã‚„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹åŒ–
      if (
        e.target.closest(".todo-actions") ||
        e.target.closest(".btn") ||
        e.target.closest("form")
      ) {
        e.preventDefault();
        return;
      }

      if (e.target.classList.contains("todo-item")) {
        draggedElement = e.target;
        draggedIndex = Array.from(todoList.children).indexOf(e.target);
        e.target.style.opacity = "0.5";
        e.dataTransfer.effectAllowed = "move";
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
    todoList.addEventListener("dragover", function (e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";

      if (!draggedElement) return;

      const afterElement = getDragAfterElement(todoList, e.clientY);

      // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
      const allItems = todoList.querySelectorAll(".todo-item");
      allItems.forEach((item) => item.classList.remove("drag-over"));

      if (afterElement == null) {
        todoList.appendChild(draggedElement);
      } else {
        todoList.insertBefore(draggedElement, afterElement);
        afterElement.classList.add("drag-over");
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
    todoList.addEventListener("dragleave", function (e) {
      const allItems = todoList.querySelectorAll(".todo-item");
      allItems.forEach((item) => item.classList.remove("drag-over"));
    });

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    todoList.addEventListener("dragend", function (e) {
      if (e.target.classList.contains("todo-item")) {
        e.target.style.opacity = "1";

        // é †åºã‚’æ›´æ–°
        const todos = Array.from(todoList.children);
        const orders = todos.map((item, index) => ({
          id: item.getAttribute("data-todo-id"),
          order: index + 1,
        }));

        // ã‚µãƒ¼ãƒãƒ¼ã«é †åºã‚’é€ä¿¡
        fetch("/update-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ orders: orders }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("é †åºã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            } else {
              console.error("é †åºã®æ›´æ–°ã«å¤±æ•—:", data.error);
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
              location.reload();
            }
          })
          .catch((error) => {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
            location.reload();
          });
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®å¾Œã«é…ç½®ã™ã‚‹è¦ç´ ã‚’å–å¾—
    function getDragAfterElement(container, y) {
      const draggableElements = [
        ...container.querySelectorAll(".todo-item:not(.dragging)"),
      ];

      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;

          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY }
      ).element;
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ /å‰Šé™¤
    todoList.addEventListener("drag", function (e) {
      if (e.target.classList.contains("todo-item")) {
        e.target.classList.add("dragging");
      }
    });

    todoList.addEventListener("dragend", function (e) {
      if (e.target.classList.contains("todo-item")) {
        e.target.classList.remove("dragging");
      }
    });
  });
</script>
{% endblock %}
