{% extends "base.html" %} {% block title %}Todoè©³ç´° - Todo List App{% endblock
%} {% block content %}
<div class="todo-list-container">
  <div class="todo-header">
    <h2>Todoè©³ç´°</h2>
    <div class="todo-header-actions">
      <a href="{{ url_for('simple_list') }}" class="btn btn-secondary">ä¸€è¦§</a>
      <a href="{{ url_for('drafts') }}" class="btn btn-draft">ä¸€æ™‚ä¿å­˜</a>
      <a href="{{ url_for('create_todo') }}" class="btn btn-primary"
        >æ–°è¦ä½œæˆ</a
      >
    </div>
  </div>

  {% if todos %}
  <div class="todo-list" id="todo-list">
    {% for todo in todos %}
    <div
      class="todo-item {% if todo.is_overdue %}overdue{% elif todo.is_due_today %}due-today{% elif todo.is_due_tomorrow %}due-tomorrow{% elif todo.is_due_soon %}due-soon{% endif %}"
      draggable="true"
      data-todo-id="{{ todo.id }}"
    >
      <div class="todo-content">
        <h3 class="todo-title">{{ todo.title }}</h3>
        <p class="todo-description">{{ todo.content }}</p>
        <div class="todo-meta">
          <span class="todo-date">
            <strong>æœŸæ—¥:</strong>
            <span class="date-value">{{ todo.formatted_due_date }}</span>
            {% if todo.is_overdue %}
            <span class="badge badge-danger">æœŸé™åˆ‡ã‚Œ</span>
            {% elif todo.is_due_today %}
            <span class="badge badge-today"><strong>æœ¬æ—¥æœŸé™</strong></span>
            {% elif todo.is_due_tomorrow %}
            <span class="badge badge-tomorrow"><strong>æ˜æ—¥ã¾ã§</strong></span>
            {% elif todo.is_due_soon %}
            <span class="badge badge-warning">æœŸé™é–“è¿‘</span>
            {% endif %}
          </span>
          <span class="todo-created">
            ä½œæˆæ—¥: {{ todo.formatted_created_at }}
          </span>
        </div>
      </div>
      <div class="todo-actions">
        <a
          href="{{ url_for('edit_todo', todo_id=todo.id) }}"
          class="btn btn-edit"
          >ç·¨é›†</a
        >
        <form
          method="POST"
          action="{{ url_for('delete_todo', todo_id=todo.id) }}"
          onsubmit="return confirm('ã“ã®Todoã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');"
          style="display: inline-block"
          class="delete-form"
        >
          <button
            type="submit"
            class="btn btn-delete"
            name="delete"
            value="{{ todo.id }}"
          >
            å‰Šé™¤
          </button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <p class="empty-message">ğŸ“ TodoãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    <a href="{{ url_for('create_todo') }}" class="btn btn-primary"
      >æœ€åˆã®Todoã‚’ä½œæˆ</a
    >
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const todoList = document.getElementById("todo-list");
    if (!todoList) return;

    let draggedElement = null;
    let draggedIndex = null;

    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    todoList.addEventListener("dragstart", function (e) {
      if (e.target.classList.contains("todo-item")) {
        draggedElement = e.target;
        draggedIndex = Array.from(todoList.children).indexOf(e.target);
        e.target.style.opacity = "0.5";
        e.dataTransfer.effectAllowed = "move";
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
    todoList.addEventListener("dragover", function (e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";

      if (!draggedElement) return;

      const afterElement = getDragAfterElement(todoList, e.clientY);

      // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
      const allItems = todoList.querySelectorAll(".todo-item");
      allItems.forEach((item) => item.classList.remove("drag-over"));

      if (afterElement == null) {
        todoList.appendChild(draggedElement);
      } else {
        todoList.insertBefore(draggedElement, afterElement);
        afterElement.classList.add("drag-over");
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
    todoList.addEventListener("dragleave", function (e) {
      const allItems = todoList.querySelectorAll(".todo-item");
      allItems.forEach((item) => item.classList.remove("drag-over"));
    });

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    todoList.addEventListener("dragend", function (e) {
      if (e.target.classList.contains("todo-item")) {
        e.target.style.opacity = "1";

        // é †åºã‚’æ›´æ–°
        const todos = Array.from(todoList.children);
        const orders = todos.map((item, index) => ({
          id: item.getAttribute("data-todo-id"),
          order: index + 1,
        }));

        // ã‚µãƒ¼ãƒãƒ¼ã«é †åºã‚’é€ä¿¡
        fetch("/update-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ orders: orders }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("é †åºã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            } else {
              console.error("é †åºã®æ›´æ–°ã«å¤±æ•—:", data.error);
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
              location.reload();
            }
          })
          .catch((error) => {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
            location.reload();
          });
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®å¾Œã«é…ç½®ã™ã‚‹è¦ç´ ã‚’å–å¾—
    function getDragAfterElement(container, y) {
      const draggableElements = [
        ...container.querySelectorAll(".todo-item:not(.dragging)"),
      ];

      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;

          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY }
      ).element;
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ /å‰Šé™¤
    todoList.addEventListener("drag", function (e) {
      if (e.target.classList.contains("todo-item")) {
        e.target.classList.add("dragging");
      }
    });

    todoList.addEventListener("dragend", function (e) {
      if (e.target.classList.contains("todo-item")) {
        e.target.classList.remove("dragging");
      }
    });
  });
</script>
{% endblock %}
