# LINE通知の動作フロー

## 🔄 動作の流れ（詳細）

### 1. cron-job.orgがHTTPリクエストを送信

**時刻**: 毎日、設定した時刻（例: 朝9時）

**動作**:
- cron-job.orgが自動的に以下のURLにHTTPリクエストを送信
- `https://todo-list-app-h6za.onrender.com/send-line-notifications`

### 2. アプリが起動（スリープ中の場合）

**状況**: Renderの無料プランでは、15分間アクセスがないとスリープします

**動作**:
- HTTPリクエストを受信すると、アプリが起動します
- スリープ中の場合、**30秒程度**で起動します
- 起動後、リクエストを処理します

### 3. アプリがTodoをチェック

**動作**:
- `/send-line-notifications`エンドポイントが呼び出されます
- アプリがGoogle SheetsからすべてのTodoを読み込みます
- 各Todoの期日をチェックします

### 4. 期日が近いTodoを検出

**チェック条件**:
- 期日が**3日前**のTodo
- 期日が**前日**のTodo
- 期日が**当日**のTodo

**追加条件**:
- 完了済みでないTodo
- 「LINE通知を有効にする」がONになっているTodo

### 5. LINE通知を送信

**動作**:
- 条件に合うTodoが見つかった場合、LINE Messaging APIを使って通知を送信します
- 通知メッセージには、Todoのタイトル、期日、カテゴリなどが含まれます

### 6. アプリが再びスリープ

**動作**:
- 通知送信が完了すると、アプリは再びスリープします
- 次回のcron-job.orgのリクエストまで待機します

## 📊 タイムライン例

### 例：Todoの期日が3日後の場合

**Day 1（今日）**: Todoを作成（期日: Day 4）
- 「LINE通知を有効にする」にチェック ✅

**Day 2（1日後）**: cron-job.orgが朝9時にリクエスト送信
- アプリが起動
- Todoをチェック
- 期日が3日前ではない → 通知なし

**Day 3（2日後）**: cron-job.orgが朝9時にリクエスト送信
- アプリが起動
- Todoをチェック
- 期日が3日前ではない → 通知なし

**Day 4（3日後）**: cron-job.orgが朝9時にリクエスト送信
- アプリが起動
- Todoをチェック
- **期日が3日前！** → **LINE通知を送信** 📱

**Day 5（4日後）**: cron-job.orgが朝9時にリクエスト送信
- アプリが起動
- Todoをチェック
- 期日が前日！ → **LINE通知を送信** 📱

**Day 6（5日後）**: cron-job.orgが朝9時にリクエスト送信
- アプリが起動
- Todoをチェック
- 期日が当日！ → **LINE通知を送信** 📱

## ✅ まとめ

1. **cron-job.org**: 毎日決まった時間にアプリを起こす（HTTPリクエスト送信）
2. **アプリ**: 起動して、期日が近いTodoをチェック
3. **アプリ**: 条件に合うTodoがあれば、LINE通知を送信
4. **アプリ**: 再びスリープ

## 💡 重要なポイント

- **cron-job.orgの設定は一度だけ**（最初に1回設定すればOK）
- **Todo作成時**: 「LINE通知を有効にする」チェックボックスをON/OFF（各Todoごと）
- **通知のタイミング**: 期日が3日前・前日・当日の3回
- **スリープからの復帰**: 初回アクセス時に30秒程度かかる

